language: python
install: true
sudo: required
python:
  - '3.6'
install:
  - poetry install -E ingestion
  - sudo cat /etc/docker/daemon.json
  - cd engine && make
  - cd ..
script:
  # Run static type checker first to short circuit obvious errors
  - poetry run mypy splitgraph
  # The majority of the test suite doesn't depend on {pg,mongo,mysql}origin being up and they
  # take a lot of time to start up (especially the first time). So, whilst the 3 DBs are busy starting up,
  # we run the core tests against the local/remote engines and then run the rest of the tests (about 10% of them)
  # with the databases up, merging coverage.
  - poetry run pytest -v -m "not mounting and not example"
  - ./wait-for-test-architecture.sh --mounting
  - poetry run pytest -v -m "mounting and not example" --cov-append
  # The "example" test suite needs the test services to be down, since it tests the end-to-end flow
  # of bringing them up and running each example.
  - ./.ci/down_architecture.sh
  - poetry run pytest -sv -m "example" --cov-append
  - docker images

services:
  - docker

env:
  global:
    - secure: 'h3RGGiUxXzirelNuxyqbb5Qgqahg4aL2LCVXKaVkoq0SIGftHSHy4Hu0QEV8h5UGQIaXLIyMeNZcS5XPuYg0MBEz5mP0MJyUj4E9l/TJFSyKQHiFUjB34d16vf/xkSzCBMkNbOltNNKe4gonZhn3/I8uRMF9ZyfsoP1SC8B3B7+C7wCZhNS6hvFXG0+n9+HDQDsx6Tws0Oa28YHctzLcFp5mTCr+cBUGqJ1NphuOqAfsRzgj1poWt0uU2XysbcJ3nSBFrPWYjtgF7IFP/G0NqrYF7cQ60G4R9GhAbyPmrc7AF7NHfjrreu4+3199NMpSbQtumLWBIAxkhblSU7likiLEIVw3hIipNHXKnSiMXeGRlcNBMrb2vO57cTifhtwi7fzHHrsVOjnYANmCQHM+nDS7rj5j2hXPUmAr1Zw6AZ4HYGW0iL+79eB5IfyKRqc75/YPyRnYSDjz6oiwlGYWrAlgWnz3Nwa5/TcCNMA7u9N3Lml4P/Wly3aC/87yPa8gT0SM/KRfweslcx29JsRkxjeRfOe8cyejAvQonN/RFibdOo/CD02oNu3Bzp5EaNW0FY/cWDi4diq4ok+t5Z0ID1i6NXBd9xPqYJiWWNGnh5lNIi6N/flFomwJpocDiIInOWCF6+y/K6SrLV2pGCBlyItjhbC9rMO9FrOnO45QScA='
    - COMPOSE_VERSION: '1.25.4'
    - DOCKER_REPO: splitgraph
    - DOCKER_ENGINE_IMAGE: engine
    - DOCKER_TAG: development
  matrix:
    - BINARY_OUTPUT: 'sgr-linux'

cache:
  pip: true
  directories:
    - docker_images

before_install:
  # Update docker to 19 to get buildkit support
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
  # Disable https://mirror.gcr.io Docker registry mirror since it breaks with Buildkit
  # https://github.com/moby/moby/issues/39120
  # https://github.com/moby/buildkit/issues/606
  - "echo '{\"mtu\": 1460}' | sudo dd of=/etc/docker/daemon.json && sudo systemctl restart docker"
  - './.ci/before_install.sh'

before_script:
  - './.ci/before_script.sh'

before_cache:
  # Save the actual tag rather than calling `docker images -q` so that the tag gets restored
  # on docker load.
  - docker save -o docker_images/engine.tar $DOCKER_REPO/$DOCKER_ENGINE_IMAGE:$DOCKER_TAG

after_success:
  - poetry run coveralls

# How to release:
# * on master:
# * do bumpversion {major,minor,patch,release} to bump version constant where needed
# * git push --tags
#
# TODO there's a workflow in which only non-dev versions get tags and are released
#   and -dev versions are considered floating: master always has a -dev version in it unless
#   a release is in progress. That way we have a way to refer to temporary nighly artifacts.
#   So say master is on 1.0.0-dev and we want to do a release -- then we first bump a version
#   to 1.0.0, do a release based on that (so all artifacts have 1.0.0 as their version) and then
#   bump the version to 1.0.1-dev without any tagging so that whatever we build off of that commit
#   has version 1.0.1-dev and isn't "frozen".

# How to undo a release:
# * Remove the release from the releases page on GH
# * git tag -d <tag>  -- delete tag locally
# * git push origin :<tag> -- delete tag remotely on GH
# * delete the release from pypi (won't be able to push the same version again)

before_deploy:
  - './.ci/before_deploy.sh'
deploy:
  - provider: releases
    api_key:
      secure: 'BL9bLoFZB/1hZfq8vez4i+A1y6O//slLqdTjcWJPCr6G4kBIkwbQsSPjsyMpJACNlzNbCo02bGROIttlEWVJ11jxYHioKWexG7j4pTMQNwup96s9PRTwm8o4H/64a6PT4+ruCVz0wO7qzet5y6QTx5oOZZqEIB/93X8PAhpednU0eq9Vedf3VjutZ3xXEMsgfltkE7Lm3b0brHKQVQOoecudRt1mFLduusUx1lsO+V7Wu8pET2zIn7g6W8sUiPYgtsrcZ8bFyl3OewyYEFyb0e45EW2KWFnf0Ozm0GNEz6FlyRo6JmcmfdkjWoM7mHSiTj2vCnz/FsJwsIJS1z4RRaSe2gJe9kQSHNy0erCr8eehJyphsYBbqyLjXuP3e9QzdLJAsdhqV+KFK5QGOEjIhKTY6IiFctF8yeKiEKL/kD31KPQcnFX/RDrwEUGWkBfaqwlORZC68Q4P2ZkbW1ydsdYcthFhFE6IFhs0sZDdreOVHsM1t0CwePpWPU+iFb1j2HQv9LROFo7G404PpnjbkP+UIZChxMZxv3s2FOeFMDiTCJEiPHMw8Q6kRJmi9+3qZULkjcWnpSb02YBiJjaXJng93o7H85cb6G5HfmGmlphe6+8twQsS7v3pB+DTDLSKLu3VS3LlUP92EwM3H9+BZqR3tpFVmDoimVjYfydkmKc='
    file: dist/${BINARY_OUTPUT}
    skip_cleanup: true
    on:
      repo: splitgraph/splitgraph
      tags: true
      # Uncomment this to trigger deploys from all branches
      # all_branches: true
  - provider: script
    # Remove -r testpypi to publish to the real PyPI
    # NB PyPI is write-once: once we've published a version, we can't overwrite it!
    script: poetry publish -r testpypi
    skip_cleanup: true
    on:
      repo: splitgraph/splitgraph
      tags: true
      # Uncomment this to trigger deploys from all branches
      # all_branches: true
  - provider: script
    script: .ci/push_engine.sh
    skip_cleanup: true
    on:
      repo: splitgraph/splitgraph
      # Only do this on master but even if there are no tags: in that case,
      # we push out a "latest" image + a commit hash image.
      # Uncomment this to trigger deploys from all branches
      # all_branches: true
